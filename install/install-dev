#!/usr/bin/env bash

source $MYARCHY_DIR/install/lib.sh

install_docker() {
    install_packages docker docker-compose
    install_yay_packages lazydocker
    sudo systemctl enable --now docker.socket # Start on first usage, different from .service which start on boot
}

install_rust() {
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
}

install_android_studio() {
    # TODO: Make a full installation
    install_yay_packages android-studio
    # TODO: Set env vars for android-studio, actually they had been written manually inside the bashrc file
    # https://developer.android.com/tools/variables#envar
}

install_flutter() {
    # TODO: Make a full installation
    install_packages glu
    mkdir -p ~/development

    local installed_version=$(flutter --version | grep -oP 'Flutter \K[0-9.]+')
    local target_version="3.35.1"

    if version_ge "$installed_version" "$target_version"; then
        echo "Flutter $installed_version is already installed, skipping installation"
    else
        curl --proto '=https' --tlsv1.2 -sSf https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_$target_version-stable.tar.xz -o /tmp/flutter.tar.xz
        tar -xf /tmp/flutter.tar.xz -C ~/development/

        myarchy-file-robust-insert-with-marker ~/.bash_profile "Flutter SDK" 'export PATH="$HOME/development/flutter/bin:$PATH"'
    fi
}

install_python() {
    install_packages python-pip
}

AVAILABLE_FEATURES=(
    "docker"
    "rust"
    "android-studio"
    "flutter"
    "python"
)

selected_features=$(gum choose --header "Select dev features to install" --no-limit "${AVAILABLE_FEATURES[@]}")
for feature in $selected_features; do
    case $feature in
    "docker") install_docker ;;
    "rust") install_rust ;;
    "android-studio") install_android_studio ;;
    "flutter") install_flutter ;;
    "python") install_python ;;
    esac
done
