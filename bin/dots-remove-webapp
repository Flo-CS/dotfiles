#!/usr/bin/env bash

ICON_DIR="$HOME/.local/share/applications/icons"
DESKTOP_DIR="$HOME/.local/share/applications"

get_all_webapps() {
    find "$DESKTOP_DIR" -name '*.desktop' -print0 |
        while read -r -d '' file; do
            if grep -q '^Exec=.*dots-launch-webapp.*' "$file"; then
                basename "${file%.desktop}"
            fi
        done | sort
}

remove_webapp() {
    local app="$1"
    rm -f "$DESKTOP_DIR/$app.desktop"
    rm -f "$ICON_DIR/$app.png"
    echo "Removed $app"
}

if [ "$#" -eq 0 ]; then
    webapps=$(get_all_webapps)

    if [ -z "$webapps" ]; then
        echo "No web apps to remove."
        exit 1
    fi

    selected=$(echo "$webapps" | gum choose --no-limit --header "Select web app to remove..." --selected-prefix="âœ— ")

    if [ -z "$selected" ]; then
        echo "You must provide web app names."
        exit 1
    fi

    echo "$selected" | while read -r app; do
        [ -n "$app" ] && remove_webapp "$app"
    done
else
    for app in "$@"; do
        remove_webapp "$app"
    done
fi
