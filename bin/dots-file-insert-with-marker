#!/usr/bin/env bash

file="$1"
marker="$2"
content="$3"
comment_char_opening="${4:-#}"
comment_char_closing="${5:-#}"

start="$comment_char_opening AUTOGENERATED START $marker $comment_char_closing"
end="$comment_char_opening AUTOGENERATED END $marker $comment_char_closing"

dots-backup-file "$file"

# Create temp file to preserve original location
temp_file=$(mktemp)

if grep -Fq "$start" "$file" 2>/dev/null; then
	# Replace content between markers
	start_line=$(grep -Fn "$start" "$file" | cut -d: -f1)
	end_line=$(grep -Fn "$end" "$file" | cut -d: -f1)

	# Copy before, insert new content, copy after
	{
		head -n $((start_line - 1)) "$file" 2>/dev/null || true
		printf '%s\n%s\n%s\n' "$start" "$content" "$end"
		tail -n +$((end_line + 1)) "$file" 2>/dev/null || true
	} >"$temp_file"
	cp "$temp_file" "$file"
else
	# Append new content if markers don't exist
	cp "$file" "$temp_file"
	printf '%s\n%s\n%s\n' "$start" "$content" "$end" >>"$temp_file"
	cp "$temp_file" "$file"
fi

rm -f "$temp_file"
echo "inserted content with marker $marker in $file"
