#!/usr/bin/env bash

BIN_DIR="$HOME/.local/bin"
DESKTOP_DIR="$HOME/.local/share/applications"
ICON_DIR="$DESKTOP_DIR/icons"

if [ "$#" -eq 0 ]; then
    # Find all AppImages by looking for desktop files with BIN_DIR in Exec line
    appimages=$(find "$DESKTOP_DIR" -name '*.desktop' -print0 |
        while read -r -d '' file; do
            exec_line=$(grep "^Exec=" "$file" | cut -d= -f2)
            if echo "$exec_line" | grep -q "$BIN_DIR"; then
                basename "${file%.desktop}"
            fi
        done | sort)

    if [ -z "$appimages" ]; then
        echo "No AppImages to remove."
        exit 1
    fi

    selected=$(echo "$appimages" | gum choose --no-limit --header "Select AppImage to remove..." --selected-prefix="âœ— ")

    if [ -z "$selected" ]; then
        echo "No AppImage selected."
        exit 1
    fi

    # Remove selected AppImages
    echo "$selected" | while read -r app; do
        if [ -n "$app" ]; then
            rm -f "$BIN_DIR/$app"
            rm -f "$DESKTOP_DIR/$app.desktop"
            rm -f "$ICON_DIR/$app.png"
            echo "Removed $app"
        fi
    done
else
    # Remove specified AppImages
    for app in "$@"; do
        rm -f "$BIN_DIR/$app"
        rm -f "$DESKTOP_DIR/$app.desktop"
        rm -f "$ICON_DIR/$app.png"
        echo "Removed $app"
    done
fi
