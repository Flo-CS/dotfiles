#!/usr/bin/env bash

scope=${1:-user} # or "system"
case $scope in
user) SCOPE_ARGS="--user" ;;
system) SCOPE_ARGS="--system" ;;
esac

REMOTE="flathub"

pkg_to_install=$(
  flatpak remote-ls $SCOPE_ARGS "$REMOTE" --app --columns=application,name |
    fzf --multi \
      --with-nth=2.. \
      --preview "flatpak remote-info $SCOPE_ARGS $REMOTE {1}" \
      --preview-window 'down:65%:wrap' \
      --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up' \
      --bind 'alt-k:preview-up,alt-j:preview-down' \
      --color 'pointer:green,marker:green'
)

if [[ -n "$pkg_to_install" ]]; then
  echo "$pkg_to_install" | awk '{print $1}' | tr '\n' ' ' | xargs flatpak install -y $source
fi
