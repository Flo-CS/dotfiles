#!/usr/bin/env bash

set -euo pipefail

get_reminder_date() {
    local date=""
    while true; do
        date=$(gum input --placeholder "Enter date (basic natural language is supported)")

        if [[ -z "$date" ]]; then
            echo "Date cannot be empty." >&2
            continue
        fi

        if dots-date-parse --validate "$date"; then
            break
        else
            echo "Invalid date format: '$date'" >&2
        fi
    done

    echo "$date"
}

create_reminder() {
    local name="$1"
    local date_input="$2"
    local formatted_date

    formatted_date=$(dots-date-parse -f at "$date_input")

    if echo "notify-send -u critical \"Reminder: $name\"" | at "$formatted_date"; then
        echo "âœ“ Reminder set: '$name' at $formatted_date"
        return 0
    else
        echo "Failed to create reminder." >&2
        return 1
    fi
}

name=$(gum write --placeholder "Enter reminder name" --width 50)
if [[ -z "$name" ]]; then
    echo "Reminder name cannot be empty." >&2
    exit 1
fi

date_input=$(get_reminder_date)
create_reminder "$name" "$date_input"
