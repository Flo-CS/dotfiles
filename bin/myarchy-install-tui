#!/usr/bin/env bash

# Setup directories
DESKTOP_DIR="$HOME/.local/share/applications"
ICON_DIR="$DESKTOP_DIR/icons"
mkdir -p "$DESKTOP_DIR" "$ICON_DIR"

# Get user input
app_name=$(gum input --header "Name" --placeholder "e.g., Htop, Nmtui, etc.")
app_exec=$(gum input --header "Launch command" --placeholder "e.g., htop, nmtui, etc.")
app_should_use_bash=$(gum confirm "Does it need bash session ?")
app_class=$(gum choose --header "Window style/class" Myarchy.App Myarchy.BigApp Myarchy.TiledApp --selected Myarchy.BigApp)
icon_url=$(gum input --header "Icon URL" --placeholder "See https://dashboardicons.com (must use PNG!)")

# Validate required fields
if [ -z "$app_name" ] || [ -z "$app_exec" ] || [ -z "$app_class" ]; then
	echo "All fields are required."
	exit 1
fi

# Setup file paths
desktop_file="$DESKTOP_DIR/$app_name.desktop"
icon_path="$ICON_DIR/$app_name.png"

# Download icon
if ! curl -sL -o "$icon_path" "$icon_url"; then
	echo "Failed to download icon."
fi

# Build execution command
exec_cmd="alacritty --class $app_class"
if $app_should_use_bash; then
	exec_cmd="$exec_cmd --hold -e bash -i -c \"$app_exec\""
else
	exec_cmd="$exec_cmd -e $app_exec"
fi

# Create desktop file
cat >"$desktop_file" <<EOF
[Desktop Entry]
Version=1.0
Name=$app_name
Comment=$app_name
Exec=$exec_cmd
Terminal=false
Type=Application
Icon=$icon_path
StartupNotify=true
EOF

chmod +x "$desktop_file"
echo "Application '$app_name' created successfully!"

if [ -n "$MYARCHY_DIR" ] && gum confirm "Do you also want to copy it in your myarchy files ?"; then
	cp "$desktop_file" "$MYARCHY_DIR/files/applications/"
	cp "$icon_path" "$MYARCHY_DIR/files/applications/icons/"
fi
