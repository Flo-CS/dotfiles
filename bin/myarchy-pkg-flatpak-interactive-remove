#!/usr/bin/env bash

scope=${1:-user} # or "system"
case $scope in
user) SCOPE_ARGS="--user" ;;
system) SCOPE_ARGS="--system" ;;
esac

pkg_to_remove=$(
  flatpak list $SCOPE_ARGS --app --columns=application,name |
    fzf --multi \
      --with-nth=2.. \
      --preview "flatpak info {1}" \
      --preview-window 'down:65%:wrap' \
      --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up' \
      --bind 'alt-k:preview-up,alt-j:preview-down' \
      --color 'pointer:red,marker:red'
)

if [[ -n "$pkg_to_remove" ]]; then
  echo "$pkg_to_remove" |
    awk '{print $1}' |
    tr '\n' ' ' |
    xargs -r flatpak uninstall $SCOPE_ARGS -y --delete-data
fi
