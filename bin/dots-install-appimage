#!/usr/bin/env bash

BIN_DIR="$HOME/.local/bin"
DESKTOP_DIR="$HOME/.local/share/applications"
ICON_DIR="$DESKTOP_DIR/icons"
mkdir -p "$BIN_DIR" "$DESKTOP_DIR" "$ICON_DIR"

if [ "$#" -eq 0 ]; then
    appimage_file=$(gum file --file --directory=false)
else
    appimage_file="$1"
fi

if [ ! -f "$appimage_file" ]; then
    echo "AppImage file not found."
    exit 1
fi

app_name=$(gum input --header "Application name" --value "$(basename "${appimage_file%.AppImage}")")
app_comment=$(gum input --header "Description (optional)")

if [ -z "$app_name" ]; then
    echo "Application name is required."
    exit 1
fi

binary_path="$BIN_DIR/$app_name"
desktop_file="$DESKTOP_DIR/$app_name.desktop"
icon_path="$ICON_DIR/$app_name.png"

cp "$appimage_file" "$binary_path"
chmod +x "$binary_path"

temp_dir=$(mktemp -d)
cd "$temp_dir" || exit 1
echo "Binary copied to $binary_path"

"$binary_path" --appimage-extract >/dev/null 2>&1

icon_files=$(fd '.*(svg|png)' --base-directory squashfs-root/usr/share)
icon_file=squashfs-root/usr/share/$(gum filter --header "Icon file" $icon_files)
if [ -f "$icon_file" ]; then
    cp "$icon_file" "$icon_path"
    echo "Icon extracted successfully"
else
    echo "No icon found in AppImage"
fi

cd - >/dev/null
rm -rf "$temp_dir"

cat >"$desktop_file" <<EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=$app_name
Comment=$app_comment
Exec=$binary_path
Icon=$icon_path
Terminal=false
StartupNotify=true
EOF

chmod +x "$desktop_file"

echo "Successfully installed $app_name!"
