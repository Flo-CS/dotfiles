#!/usr/bin/env bash

dmenu() {
	local prompt=$1

	pkill -x wofi
	wofi --dmenu --prompt "$prompt" --insensitive
}

show_select_theme_menu() {
	selected=$(myarchy-theme-list | dmenu "Select theme")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		myarchy-theme-set "$selected"
	fi
}

show_select_wallpaper_menu() {
	selected=$(myarchy-wallpaper-list | dmenu "Select wallpaper")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		myarchy-wallpaper-set "$selected"
	fi
}

show_refresh_menu() {
	# FIXME: replace by explicit refresh commands
	selected=$(fd '^myarchy-refresh-' "$MYARCHY_DIR/bin" -x basename {} | sed 's/^myarchy-refresh-//' | dmenu "Refresh menu")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		cmd=${selected// /-}
		myarchy-refresh-$cmd
	fi
}

show_applications_menu() {
	if wofi --show drun; then
		exit 0
	else
		show_main_menu
	fi
}

show_deploy_menu() {
	selected=$(printf '  Configs
󰣆  Applications' | dmenu "Deploy menu")
	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		case "$selected" in
		*"Configs"*) myarchy-launch-tui-menu myarchy-deploy-config ;;
		*"Applications"*) myarchy-launch-tui-menu myarchy-deploy-applications ;;
		esac
	fi
}

show_system_menu() {
	selected=$(printf '  Reboot
⏻  Shutdown
  Lock' | dmenu "System menu")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		case "$selected" in
		*"Reboot"*) systemctl reboot ;;
		*"Shutdown"*) systemctl poweroff ;;
		*"Lock"*) myarchy-lock-screen ;;
		esac
	fi
}

show_screenshot_menu() {
	selected=$(printf '󰍹  Fullscreen
󰍺  Area
󰍻  Window' | dmenu "Screenshot menu")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		case "$selected" in
		*"Fullscreen"*) myarchy-screenshot output ;;
		*"Area"*) myarchy-screenshot region ;;
		*"Window"*) myarchy-screenshot window ;;
		esac
	fi
}

show_power_profile_menu() {
	selected=$(myarchy-power-profiles-list | dmenu "Power profile menu")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		powerprofilesctl set "$selected"
		if [[ $? -eq 0 ]]; then
			notify-send "Power profile set to $(powerprofilesctl get)" -u low
		else
			notify-send "Failed to set power profile" -u critical
		fi
	fi
}

show_toggle_menu() {
	selected=$(printf '' | dmenu "Toggle menu")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		case "$selected" in
		*"Idle inhibitor"*) myarchy-toggle-idle-inhibitor ;; # FIXME: not working for the moment
		esac
	fi
}

show_install_menu() {
	selected=$(printf '󰏖  TUI
󰏖  Webapp
󰏖  Appimage
󰏖  Package
󰏖  AUR Package
󰏖  Flatpak' | dmenu "Install menu")

	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		case "$selected" in
		*"TUI"*) myarchy-launch-tui-menu myarchy-install-tui ;;
		*"Webapp"*) myarchy-launch-tui-menu myarchy-install-webapp ;;
		*"Appimage"*) myarchy-launch-tui-menu myarchy-install-appimage ;;
		*"AUR Package"*) myarchy-launch-tui-menu myarchy-pkg-yay-interactive-install ;;
		*"Package"*) myarchy-launch-tui-menu myarchy-pkg-interactive-install ;;
		*"Flatpak"*) myarchy-launch-tui-menu myarchy-pkg-flatpak-interactive-install ;;
		esac
	fi
}

show_remove_menu() {
	selected=$(printf '󰏘  TUI
󰏘  Webapp
󰏘  Appimage
󰏘  Package
󰏘  Flatpak' | dmenu "Remove menu")
	if [[ -z "$selected" ]]; then
		show_main_menu
	else
		case "$selected" in
		*"TUI"*) myarchy-launch-tui-menu myarchy-remove-tui ;;
		*"Webapp"*) myarchy-launch-tui-menu myarchy-remove-webapp ;;
		*"Appimage"*) myarchy-launch-tui-menu myarchy-remove-appimage ;;
		*"Package"*) myarchy-launch-tui-menu myarchy-pkg-interactive-remove ;;
		*"Flatpak"*) myarchy-launch-tui-menu myarchy-pkg-flatpak-interactive-remove ;;
		esac
	fi
}

show_main_menu() {
	selected=$(printf '  Theme
󱍷  Refresh
󰸉  Wallpaper
󰚰  Update
󰆨  Deploy
󰇄  System
  Bluetooth
󰀂  Network
  Audio
󰹑  Screenshot
󰣆  Applications
󰟌  Monitor
  Info
󰩲  Power profile
  Toggle
󰁯  Snapshot system
  Install
  Remove
󰥔  Time' | dmenu "Myarchy menu")

	case "$selected" in
	*"Theme"*) show_select_theme_menu ;;
	*"Refresh"*) show_refresh_menu ;;
	*"Wallpaper"*) show_select_wallpaper_menu ;;
	*"Update"*) myarchy-launch-tui-menu myarchy-update ;;
	*"Deploy"*) show_deploy_menu ;;
	*"System"*) show_system_menu ;;
	*"Screenshot"*) show_screenshot_menu ;;
	*"Bluetooth"*) myarchy-launch-tui-app bluetuith --no-warning ;;
	*"Network"*) myarchy-launch-tui-app nmtui ;;
	*"Audio"*) myarchy-launch-tui-app wiremix ;;
	*"Applications"*) show_applications_menu ;;
	*"Monitor"*) myarchy-launch-tui-big-app btop ;;
	*"Info"*) myarchy-launch-tui-menu fastfetch ;;
	*"Power profile"*) show_power_profile_menu ;;
	*"Toggle"*) show_toggle_menu ;;
	*"Snapshot system"*) myarchy-launch-tui-menu myarchy-snapshot-system ;;
	*"Install"*) show_install_menu ;;
	*"Remove"*) show_remove_menu ;;
	*"Time"*) show_time_menu ;;
	*) exit 0 ;;
	esac
}

show_main_menu
